# Изменения БД на проде

## Текущая логика (после последних изменений):

✅ **Сравнение ответов идет по ТЕКСТУ**, а не по индексу
✅ В `quiz_results.answer` сохраняется **ТЕКСТ** ответа
✅ Telegram передает текст в том же формате, что в БД

## Что нужно на проде:

### ОБЯЗАТЕЛЬНО:

1. **Колонка `questions.correct_answer_text`** - нужна для получения текста правильного ответа
   - Без неё метод `getCorrectAnswerText()` не будет работать
   - Миграция: `2026_01_12_130620_add_correct_answer_text_to_questions_table.php`

### ОПЦИОНАЛЬНО (но рекомендуется):

2. **Колонка `active_quizzes.correct_answer_index`** - для справки и отладки
   - Не критично для работы, но полезно для диагностики
   - Миграция: `2026_01_12_125241_add_correct_answer_index_to_active_quizzes_table.php`

## Рекомендация: ПРИМЕНИТЬ ОБЕ МИГРАЦИИ

### Почему:

1. ✅ `correct_answer_text` - **критично** для работы текущей логики
2. ✅ `correct_answer_index` - полезно для отладки и может пригодиться в будущем
3. ✅ Миграции безопасны - они не удаляют данные, только добавляют колонки
4. ✅ Миграция `correct_answer_text` автоматически конвертирует существующие данные

## Команды для прода:

```bash
# 1. Применить миграции
php artisan migrate

# 2. Проверить структуру
php artisan db:check-structure

# 3. (Опционально) Конвертировать существующие вопросы, если они еще не конвертированы
php artisan questions:convert-to-index

# 4. Проверить работу
php artisan quiz:test-answer-logic
```

## Что будет изменено:

### Таблица `questions`:
- ✅ Добавится колонка `correct_answer_text` (string, nullable)
- ✅ Существующие данные: `correct_answer` (текст) → `correct_answer_text`, `correct_answer` → '0' (индекс)

### Таблица `active_quizzes`:
- ✅ Добавится колонка `correct_answer_index` (integer, nullable)
- ✅ Существующие данные не изменятся

### Таблица `quiz_results`:
- ✅ Ничего не изменится (уже хранит текст в `answer`)

## Безопасность:

✅ Миграции безопасны:
- Не удаляют данные
- Не изменяют существующие колонки (кроме `correct_answer` в `questions`)
- Можно откатить: `php artisan migrate:rollback --step=2`

## Если НЕ применять миграции:

❌ Без `correct_answer_text`:
- Метод `getCorrectAnswerText()` будет падать с ошибкой
- Проверка ответов не будет работать
- Бот будет выдавать 500 ошибки

⚠️ Без `correct_answer_index`:
- Работать будет, но не будет дополнительной информации для отладки
- Команды диагностики могут показывать неполную информацию

## Вывод:

**РЕКОМЕНДУЕТСЯ ПРИМЕНИТЬ ОБЕ МИГРАЦИИ** для полной совместимости и надежности.
